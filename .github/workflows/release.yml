name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Build
        run: |
          xcodebuild -resolvePackageDependencies -project CCSwitch/CCSwitch.xcodeproj
          
          xcodebuild -scheme CCSwitch \
            -project CCSwitch/CCSwitch.xcodeproj \
            -configuration Release \
            -derivedDataPath build \
            -archivePath CCSwitch.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION=$VERSION \
            CURRENT_PROJECT_VERSION=$VERSION

      - name: Export Archive (Ad-hoc)
        run: |
          mkdir -p dist
          cp -R "CCSwitch.xcarchive/Products/Applications/CCSwitch.app" dist/
          
      - name: Debug Info.plist
        run: |
          echo "Verifying Info.plist version..."
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" dist/CCSwitch.app/Contents/Info.plist
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" dist/CCSwitch.app/Contents/Info.plist

      - name: Export Archive (Ad-hoc)
        run: |
          mkdir -p dist
          # 查找生成的 .app 路径，通常在 Products/Applications 下
          cp -R "CCSwitch.xcarchive/Products/Applications/CCSwitch.app" dist/
          
          # 修复图标丢失问题：手动将 .icns 复制到 Resources 目录
          # 因为 Xcode 工程中可能未正确包含该资源
          mkdir -p dist/CCSwitch.app/Contents/Resources/
          cp CCSwitch/CCSwitch/Resources/AppIcon.icns dist/CCSwitch.app/Contents/Resources/
          
          # 修复本地化丢失问题：手动将 .lproj 文件夹复制到 Resources 目录
          cp -R CCSwitch/CCSwitch/Resources/*.lproj dist/CCSwitch.app/Contents/Resources/
          
      - name: Ad-hoc Sign App
        run: |
          # 使用 ad-hoc 签名 (-s -) 以通过 Sparkle 的基本检查
          codesign --force --deep -s - dist/CCSwitch.app

      - name: Zip App
        run: |
          cd dist
          zip -r CCSwitch.zip CCSwitch.app
          echo "ZIP_PATH=$(pwd)/CCSwitch.zip" >> $GITHUB_ENV

      - name: Create DMG
        run: |
          # 准备 DMG 源目录
          mkdir -p dmg_source
          cp -R dist/CCSwitch.app dmg_source/
          ln -s /Applications dmg_source/Applications
          
          # 生成 DMG
          hdiutil create -volname "CCSwitch" -srcfolder dmg_source -ov -format UDZO dist/CCSwitch.dmg

      - name: Install Sparkle Tools
        run: |
          curl -L -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
          tar -xf sparkle.tar.xz
          mv bin sparkle-bin

      - name: Import Sparkle Key to Keychain
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # 创建临时 Keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/sparkle.keychain-db
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          
          # 将其设为默认搜索列表的一部分，以便 generate_appcast 能找到
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed 's/"//g')

          # 添加私钥到 Keychain (Sparkle 标准位置)
          # -a Account: ed25519
          # -s Service: https://sparkle-project.org
          # -w Password: 私钥内容
          # -A 允许所有程序访问
          security add-generic-password -a "ed25519" -s "https://sparkle-project.org" -w "$SPARKLE_PRIVATE_KEY" -A "$KEYCHAIN_PATH"

      - name: Generate Appcast
        run: |
          mkdir -p sparkle_feed
          cp dist/CCSwitch.zip sparkle_feed/
          
          # 自动从 Keychain 读取私钥
          ./sparkle-bin/generate_appcast sparkle_feed/ \
            --download-url-prefix "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/"
            
          cp sparkle_feed/appcast.xml .

      - name: Update appcast.xml in Repo
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 切换到 main 分支（actions/checkout 默认是 detached head）
          git fetch origin main
          git checkout main
          
          # 添加生成的 appcast.xml
          git add appcast.xml
          
          # 如果有变化则提交
          if git diff --staged --quiet; then
            echo "No changes to appcast.xml"
          else
            git commit -m "chore: update appcast.xml for v${VERSION}"
            git push origin main
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/CCSwitch.zip
            dist/CCSwitch.dmg
            appcast.xml
          draft: false
          prerelease: false