name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Update Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" CCSwitch/CCSwitch/Resources/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" CCSwitch/CCSwitch/Resources/Info.plist

      - name: Build
        run: |
          xcodebuild -resolvePackageDependencies -project CCSwitch/CCSwitch.xcodeproj
          
          xcodebuild -scheme CCSwitch \
            -project CCSwitch/CCSwitch.xcodeproj \
            -configuration Release \
            -derivedDataPath build \
            -archivePath CCSwitch.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Export Archive (Ad-hoc)
        run: |
          mkdir -p dist
          # 查找生成的 .app 路径，通常在 Products/Applications 下
          cp -R "CCSwitch.xcarchive/Products/Applications/CCSwitch.app" dist/
          
      - name: Ad-hoc Sign App
        run: |
          # 使用 ad-hoc 签名 (-s -) 以通过 Sparkle 的基本检查
          codesign --force --deep -s - dist/CCSwitch.app

      - name: Zip App
        run: |
          cd dist
          zip -r CCSwitch.zip CCSwitch.app
          echo "ZIP_PATH=$(pwd)/CCSwitch.zip" >> $GITHUB_ENV

      - name: Install Sparkle Tools
        run: |
          curl -L -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
          tar -xf sparkle.tar.xz
          mv bin sparkle-bin

      - name: Generate Appcast
        env:
          # Sparkle 工具支持通过环境变量读取私钥
          SUPrivateEDKey: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          mkdir -p sparkle_feed
          cp dist/CCSwitch.zip sparkle_feed/
          
          # 不再需要写入临时文件或使用 -s 参数
          ./sparkle-bin/generate_appcast sparkle_feed/ \
            --download-url-prefix "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/"
            
          cp sparkle_feed/appcast.xml .

      - name: Update appcast.xml in Repo
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 切换到 main 分支（actions/checkout 默认是 detached head）
          git fetch origin main
          git checkout main
          
          # 添加生成的 appcast.xml
          git add appcast.xml
          
          # 如果有变化则提交
          if git diff --staged --quiet; then
            echo "No changes to appcast.xml"
          else
            git commit -m "chore: update appcast.xml for v${VERSION}"
            git push origin main
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/CCSwitch.zip
            appcast.xml
          draft: false
          prerelease: false